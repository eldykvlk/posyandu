<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Pelayanan</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Data Pelayanan untuk <span id="namaPesertaLabel"></span></h2>
        <label for="tahunLayanan">Pilih Tahun:</label>
        <select id="tahunLayanan" class="form-control mb-3">
            <option value="2030">2030</option>
            <option value="2029">2029</option>
            <option value="2028">2028</option>
            <option value="2027">2027</option>
            <option value="2026">2026</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
        </select>
        
        <!-- Button to trigger Add Data modal -->
        <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#addModal">Tambah Data</button>
        
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID Pelayanan</th>
                    <th>Tanggal</th>
                    <th>Umur Anak</th>
                    <th>Tinggi Badan</th>
                    <th>Berat Badan</th>
                    <th>Lingkar Kepala</th>
                    <th>Lingkar Lengan</th>
                    <th>Status Gizi</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="dataTable"></tbody>
        </table>
    </div>

    <!-- Modal for adding data -->
    <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addModalLabel">Tambah Data Pelayanan</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addForm">
                        <div class="form-group">
                            <label for="addTanggal">Tanggal Pelayanan</label>
                            <input type="date" class="form-control" id="addTanggal" >
                        </div>
                        <div class="form-group">
                            <label for="addUmurAnak">Umur Anak</label>
                            <input type="text" class="form-control" id="addUmurAnak" >
                        </div>
                        <div class="form-group">
                            <label for="addTinggiBadan">Tinggi Badan</label>
                            <input type="text" class="form-control" id="addTinggiBadan" >
                        </div>
                        <div class="form-group">
                            <label for="addBeratBadan">Berat Badan</label>
                            <input type="text" class="form-control" id="addBeratBadan" >
                        </div>
                        <div class="form-group">
                            <label for="addLingkarKepala">Lingkar Kepala</label>
                            <input type="text" class="form-control" id="addLingkarKepala" >
                        </div>
                        <div class="form-group">
                            <label for="addLingkarLengan">Lingkar Lengan</label>
                            <input type="text" class="form-control" id="addLingkarLengan" >
                        </div>
                        <div class="form-group">
                            <label for="addStatusGizi">Status Gizi</label>
                            <input type="text" class="form-control" id="addStatusGizi" >
                        </div>
                        <button type="submit" class="btn btn-primary">Simpan Data</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for editing data -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Data Pelayanan</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="form-group">
                            <label for="editTanggal">Tanggal Pelayanan</label>
                            <input type="date" class="form-control" id="editTanggal" >
                        </div>
                        <div class="form-group">
                            <label for="editUmurAnak">Umur Anak</label>
                            <input type="text" class="form-control" id="editUmurAnak" >
                        </div>
                        <div class="form-group">
                            <label for="editTinggiBadan">Tinggi Badan</label>
                            <input type="text" class="form-control" id="editTinggiBadan" >
                        </div>
                        <div class="form-group">
                            <label for="editBeratBadan">Berat Badan</label>
                            <input type="text" class="form-control" id="editBeratBadan" >
                        </div>
                        <div class="form-group">
                            <label for="editLingkarKepala">Lingkar Kepala</label>
                            <input type="text" class="form-control" id="editLingkarKepala" >
                        </div>
                        <div class="form-group">
                            <label for="editLingkarLengan">Lingkar Lengan</label>
                            <input type="text" class="form-control" id="editLingkarLengan" >
                        </div>
                        <div class="form-group">
                            <label for="editStatusGizi">Status Gizi</label>
                            <input type="text" class="form-control" id="editStatusGizi" >
                        </div>
                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const namaPeserta = urlParams.get('nama');
        const tahunLayanan = urlParams.get('tahun') || new Date().getFullYear();

        const baseUrl = "https://data-peserta-303fd-default-rtdb.firebaseio.com/pesertanew";
        const authParam = "?auth=lNDl2qGcmnJoz7q7ru9bor2mM3UxNfuXVV21j60z";

        let currentIdPelayanan = '';
        let currentBulan = '';
        let currentKey = '';

        function fetchData(nama, tahun) {
            fetch(`${baseUrl}.json${authParam}`)
                .then(response => response.json())
                .then(data => {
                    let peserta = null;
                    for (const key in data) {
                        if (data[key].nama_peserta === nama) {
                            peserta = data[key];
                            currentKey = key;
                            break;
                        }
                    }

                    if (!peserta || !peserta.data) {
                        document.getElementById('dataTable').innerHTML = '<tr><td colspan="9">Data tidak ditemukan.</td></tr>';
                        return;
                    }

                    const dataTable = document.getElementById('dataTable');
                    dataTable.innerHTML = '';

                    for (const bulan in peserta.data) {
                        for (const idPelayanan in peserta.data[bulan]) {
                            const pelayanan = peserta.data[bulan][idPelayanan];

                            if (new Date(pelayanan.tanggal_pelayanan).getFullYear() == tahun) {
                                const row = `
                                    <tr data-id="${idPelayanan}" data-bulan="${bulan}">
                                        <td>${idPelayanan}</td>
                                        <td>${pelayanan.tanggal_pelayanan || 'Belum diisi'}</td>
                                        <td>${pelayanan.umur_anak || 'Belum diisi'}</td>
                                        <td>${pelayanan.tinggi_badan || 'Belum diisi'}</td>
                                        <td>${pelayanan.berat_badan || 'Belum diisi'}</td>
                                        <td>${pelayanan.lingkar_kepala || 'Belum diisi'}</td>
                                        <td>${pelayanan.lingkar_lengan || 'Belum diisi'}</td>
                                        <td>${pelayanan.status_gizi || 'Belum diisi'}</td>
                                        <td>
                                            <button class="btn btn-primary btn-sm editBtn">Edit</button>
                                            <button class="btn btn-danger btn-sm deleteBtn">Hapus</button>
                                        </td>
                                    </tr>
                                `;
                                dataTable.innerHTML += row;
                            }
                        }
                    }
                });
        }

        $(document).ready(function() {
            $('#namaPesertaLabel').text(namaPeserta);
            $('#tahunLayanan').val(tahunLayanan);
            fetchData(namaPeserta, tahunLayanan);

            $('#tahunLayanan').on('change', function() {
                fetchData(namaPeserta, $(this).val());
            });

            $('body').on('click', '.editBtn', function() {
                const row = $(this).closest('tr');
                currentIdPelayanan = row.data('id');
                currentBulan = row.data('bulan');

                $('#editTanggal').val(row.find('td:nth-child(2)').text() === 'Belum diisi' ? '' : row.find('td:nth-child(2)').text());
                $('#editUmurAnak').val(row.find('td:nth-child(3)').text() === 'Belum diisi' ? '' : row.find('td:nth-child(3)').text());
                $('#editTinggiBadan').val(row.find('td:nth-child(4)').text() === 'Belum diisi' ? '' : row.find('td:nth-child(4)').text());
                $('#editBeratBadan').val(row.find('td:nth-child(5)').text() === 'Belum diisi' ? '' : row.find('td:nth-child(5)').text());
                $('#editLingkarKepala').val(row.find('td:nth-child(6)').text() === 'Belum diisi' ? '' : row.find('td:nth-child(6)').text());
                $('#editLingkarLengan').val(row.find('td:nth-child(7)').text() === 'Belum diisi' ? '' : row.find('td:nth-child(7)').text());
                $('#editStatusGizi').val(row.find('td:nth-child(8)').text() === 'Belum diisi' ? '' : row.find('td:nth-child(8)').text());

                $('#editModal').modal('show');
            });

            $('#editForm').on('submit', function(e) {
                e.preventDefault();

                const updatedData = {
                    tanggal_pelayanan: $('#editTanggal').val(),
                    umur_anak: $('#editUmurAnak').val(),
                    tinggi_badan: $('#editTinggiBadan').val(),
                    berat_badan: $('#editBeratBadan').val(),
                    lingkar_kepala: $('#editLingkarKepala').val(),
                    lingkar_lengan: $('#editLingkarLengan').val(),
                    status_gizi: $('#editStatusGizi').val()
                };

                fetch(`${baseUrl}/${currentKey}/data/${currentBulan}/${currentIdPelayanan}.json${authParam}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updatedData)
                }).then(response => response.json())
                  .then(() => {
                    $('#editModal').modal('hide');
                    fetchData(namaPeserta, $('#tahunLayanan').val());
                  });
            });

            $('body').on('click', '.deleteBtn', function() {
                const row = $(this).closest('tr');
                const idPelayanan = row.data('id');
                const bulan = row.data('bulan');

                fetch(`${baseUrl}/${currentKey}/data/${bulan}/${idPelayanan}.json${authParam}`, {
                    method: 'DELETE'
                }).then(response => response.json())
                  .then(() => {
                    fetchData(namaPeserta, $('#tahunLayanan').val());
                  });
            });

            $('#addForm').on('submit', function(e) {
                e.preventDefault();

                const newData = {
                    tanggal_pelayanan: $('#addTanggal').val(),
                    umur_anak: $('#addUmurAnak').val(),
                    tinggi_badan: $('#addTinggiBadan').val(),
                    berat_badan: $('#addBeratBadan').val(),
                    lingkar_kepala: $('#addLingkarKepala').val(),
                    lingkar_lengan: $('#addLingkarLengan').val(),
                    status_gizi: $('#addStatusGizi').val()
                };

                const newBulan = new Date(newData.tanggal_pelayanan).toISOString().substring(0, 7);

                fetch(`${baseUrl}/${currentKey}/data/${newBulan}.json${authParam}`, {
                    method: 'POST',
                    body: JSON.stringify(newData)
                }).then(response => response.json())
                  .then(() => {
                    $('#addModal').modal('hide');
                    fetchData(namaPeserta, $('#tahunLayanan').val());
                  });
            });
        });
    </script>
</body>
</html>
